@model Ecoset.WebUI.Models.ReportData
@using System.Globalization
@using System.Linq
@using Ecoset.GeoTemporal.Remote
@using System.Text.Json
@using Microsoft.Extensions.Options
@using Ecoset.WebUI.Options
@inject IOptions<EcosetAppOptions> siteConfig

@{
  Layout = null;

  var prettyTitles = new Dictionary<string,string>();
  prettyTitles["sea_depth"] = "Depth";
  prettyTitles["ecoregions"] = "Marine Ecoregions";
  prettyTitles["economic_zones"] = "Exclusive Economic Zones";
  prettyTitles["vulnerability"] = "Vulnerable Species";
  prettyTitles["migratory_count"] = "Migratory Species";
  prettyTitles["protected_areas"] = "Marine Protected Areas";
  prettyTitles["coastal_ecosystems"] = "Coastal Ecosystems";
  prettyTitles["critical_habitat"] = "Critical Habitat";
  prettyTitles["shipping_density"] = "Shipping Density";
  prettyTitles["fish_catches"] = "Fish Catches";
  prettyTitles["aquaculture_potential"] = "Aquaculture Potential";
  prettyTitles["windpower_potential"] = "Wind Power Potential";
  prettyTitles["wavepower_potential"] = "Wave Power Potential";
  prettyTitles["benthic_roughness"] = "Benthic Roughness";
  prettyTitles["sst"] = "Sea Surface Temperature";
  prettyTitles["sst_fronts"] = "Sea Surface Temperature Fronts";
  prettyTitles["salinity"] = "Sea Surface Salinity";
  prettyTitles["npp"] = "Net Primary Productivity";
  prettyTitles["sea_ice"] = "Sea Ice";
  prettyTitles["currents"] = "Currents";
  prettyTitles["tides"] = "Tides";
  prettyTitles["sea_state"] = "Sea State";
  prettyTitles["sst_trend"] = "Sea Surface Temperature Trend";
  prettyTitles["coral_bleaching"] = "Coral Bleaching";
  prettyTitles["acidification"] = "Ocean Acidification";
  prettyTitles["sea_level_rise"] = "Sea Level Rise";
  prettyTitles["invasive_species"] = "Invasive Species";

  var descriptions = new Dictionary<string,string>();
  descriptions["sea_depth"] = "General Bathymetric Chart of the Oceans (GEBCO) (Weatherall et al. 2015) https://gebco.net";
  descriptions["ecoregions"] = "The WWF Marine Ecoregions of the World (MEOW; Spalding et al 2007) identifies areas with similar ecological characteristics.";
  descriptions["economic_zones"] = "Flanders Marine Institute (2018). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 10. Available online at http://www.marineregions.org/ https://doi.org/10.14284/312.";
  descriptions["vulnerability"] = "The IUCN Red List of Threatened Species (IUCN 2020) was used to find the names and threat categories of species in the specified area of interest.  All corals, fish, sea birds, marine mammals and turtles determined by the IUCN to be Critically Endangered (CR), Endangered (EN), Vulnerable (VU) or Near Threatened (NT) were extracted. A list of the globally threatened species which potentially occur in the area of interest can be found in Appendix 2.";
  descriptions["migratory_count"] = "Migratory species drawn from the global register of migratory species (GROMS; Riede 2004) and distribution data (GBIF 2019).\nA list of the migratory fish, seabirds, marine mammals, and turtle species that primarily occur in the area of interest can be found in Appendix 3.";
  descriptions["protected_areas"] = "A list of the marine protected areas in the area of interest is provided in Appendix 1.";
  descriptions["coastal_ecosystems"] = "Coastal ecosystems including kelp (Byrnes et al 2016); mangroves (Bunting et al 2018); saltmarsh (McOwen et al 2017); seagrass (UNEP-WCMC et al 2018); tidal flats (Murray et al 2019); and coral reefs (UNEP WCMC et al 2018).";
  descriptions["critical_habitat"] = "International Finance Corporation (IFC) Performance Standard 6 (PS6) critical habitat map (2012a; 2012b).";
  descriptions["shipping_density"] = "Shipping density was calculated from transponder data from the World Meteorological Organisation (WMO) Voluntary Observing Ship (VMO) network. https://www.ncdc.noaa.gov/data-access/marineocean-data/vosclim \nThe algorithm described by Halpern et al (2015) was used to connect 6-hourly ship positions into ship tracks and calculate ship density quantiles.";
  descriptions["fish_catches"] = "Annual total species combined) annual fish catches by major areas from Food and Agriculture Organisation (FAO) fishbase.\nhttp://www.fao.org/fishery/statistics/software/fishstat/j/en/";
  descriptions["aquaculture_potential"] = "The potential for marine aquaculture was calculated using the INVEST algorithms developed by the Natural Capital Project (Sharp et al 2018).  The algorithm takes account of monthly climatology of sea surface temperature, distance from shore, water depth and shipping density.";
  descriptions["windpower_potential"] = "The potential for offshore wind power generation was calculated using the INVEST algorithms developed by the Natural Capital Project (Sharp et al 2018).  The algorithm takes account of satellite time-series data on wind speeds 1987-present (Zhang et al 2006); water depth, distance form shore and shipping density.";
  descriptions["wavepower_potential"] = "The potential for wave power generation was calculated using the INVEST algorithms developed by the Natural Capital Project (Sharp et al 2018).  The algorithm takes account of global significant wave height time-series data; water depth; distance from shore and shipping density.";
  descriptions["benthic_roughness"] = "Benthic roughness Wilson et al (2007) derived from General Bathymetric Chart of the Oceans (GEBCO)   (Weatherall et al 2015) https://gebco.net";
  descriptions["sst"] = "Sea surface temperature (ESA CCI; Merchant et al 2014)";
  descriptions["sst_fronts"] = "Sea surface temperature front frequency derived from sea surface temperature time series (ESA CCI; Merchant et al 2014)";
  descriptions["salinity"] = "Sea surface salinity (ESA CCI; Vergely et al 2019)";
  descriptions["npp"] = "Net primary productivity (VGPM algorithm; Behrenfeld & Falkowski 1997)";
  descriptions["sea_ice"] = "Sea ice frequency derived from Canada Meteorological Center (2016) GHRSST";
  descriptions["currents"] = "Ocean currents";
  descriptions["tides"] = "Tide height";
  descriptions["sea_state"] = "Mean significant wave height (Passaro 2019)";
  descriptions["sst_trend"] = "Sea surface temperature (ESA CCI; Merchant et al 2014)";
  descriptions["coral_bleaching"] = "Coral bleaching frequency derived from NOAA Coral Reef Watch data (Skirving et al 2018)";
  descriptions["acidification"] = "pH derived from Boyer et al (2009)";
  descriptions["sea_level_rise"] = "Sea level rise derived from sea level altimetry (Legais et al 2018)";
  descriptions["invasive_species"] = "Invasive marine species counts derived from Global Invasive Species Database (GISD; Pagad et al 2015)";

  var mapLegend = new Dictionary<string,string>();
  mapLegend["sea_depth"] = "from the General Bathymetric Chart of the Oceans (GEBCO) in specified area of interest (red rectangle) in 2015.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["ecoregions"] = "of the World (MEOW) in specified area of interest (red rectangle) and in a surrounding 3 degree buffer in 2007.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["economic_zones"] = "(sea within 200 nautical miles from a nation’s coastline) in specified area of interest (red rectangle) in 2018. High Seas is shown in white.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["vulnerability"] = "map showing the number of globally threatened (Cr, EN, VU) and near-threatened (NT) species of corals, fish, seabirds, marine mammals and turtles estimated to occur in the specified area of interest (red rectangle) in 2019.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["migratory_count"] = "map showing the number of migratory fish, seabirds, marine mammals and turtles estimated to occur in the specified area of interest (red rectangle) in 2019.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["protected_areas"] = "from the World Database of Protected Areas (WDPA) 2018 in specified area of interest (red rectangle). Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["coastal_ecosystems"] = "map showing kelp, mangroves, saltmarsh; seagrass; tidal flats; and coral reefs in the specified area of interest (red rectangle) in 2019.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["critical_habitat"] = "map showing areas which potentially meet the IFC PS6 definition of critical habitat because of the occurrence of Critically Endangered (CR) and Endangered (EN) marine species in the specified area of interest (red rectangle) in 2019.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["shipping_density"] = "map showing global quantiles of shipping density from 1 (lowest) – 100 (highest) in the specified area of interest (red rectangle) in 2018.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["fish_catches"] = "map showing total fish catches (all species) tons per year in the specified area of interest (red rectangle) in 2018.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["aquaculture_potential"] = "map showing global quantiles of aquaculture potential from 1 (lowest) – 100 (highest) in the specified area of interest (red rectangle) in 2018.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["windpower_potential"] = "map showing global quantiles of offshore wind power potential from 1 (lowest) – 100 (highest) in the specified area of interest (red rectangle) in 2018.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["wavepower_potential"] = "map showing global quantiles of wave power potential from 1 (lowest) – 100 (highest) in 2018 in the specified area of interest (red rectangle) in 2018.  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["benthic_roughness"] = "(dimensionless) in specified area of interest (red rectangle) in 2015 derived from the General Bathymetric Chart of the Oceans (GEBCO). Land is shown in grey. Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["sst"] = "map showing mean annual sea surface temperature in 2018 (degrees C) in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["sst_fronts"] = "map showing frequency of fronts in the period 2000-2018 in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["salinity"] = "map (effective salinity units) in 2018 in specified area of interest (red rectangle). Land is shown in grey. Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["npp"] = "(g C/m2/year) in period 2000-2018  in specified area of interest (red rectangle). Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["sea_ice"] = "frequency map showing (proportion of time when sea ice occurs 0-100%) in period 2000-2018 in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["currents"] = "(metres/second) in period 2000-2018 in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["tides"] = "map showing mean tide height range (metres) in the period 2000-2018 in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["sea_state"] = "(mean significant wave height metres) in the period 2000-2018 in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["sst_trend"] = "map (degrees C/decade) in specified area of interest (red rectangle)  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["coral_bleaching"] = "map (proportion of time 0-100% bleaching occurred) in the period 2000-2018 in the specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["acidification"] = "(ph units) in 2020 in the specified area of interest (red rectangle)  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["sea_level_rise"] = "map (metres/decade) in period 2000-2020 in specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";
  mapLegend["invasive_species"] = "map (number of different marine invasive species) in 2018 in the specified area of interest (red rectangle).  Land is shown in grey.  Spatial resolution is 30 arcsec, approximately 1km.";

  // TODO Use units from ecoset backend
  var units = new Dictionary<string,string>();
  units["sea_depth"] = "Depth (Metres)";
  units["ecoregions"] = "Marine ecoregion";
  units["economic_zones"] = "Exclusive economic zones";
  units["vulnerability"] = "Vulnerability";
  units["migratory_count"] = "Migratory species";
  units["protected_areas"] = "World Database of Protected Areas (WDPA) 2019";
  units["coastal_ecosystems"] = "Ecosystem";
  units["critical_habitat"] = "Critical Habitat Designation";
  units["shipping_density"] = "Quantile";
  units["fish_catches"] = "tons per year";
  units["aquaculture_potential"] = "Quantile";
  units["windpower_potential"] = "Quantile";
  units["wavepower_potential"] = "Quantile";
  units["benthic_roughness"] = "Dimensionless";
  units["sst"] = "Degrees Celsius";
  units["sst_fronts"] = "frequency (proportion of time fronts occur 0-100%)";
  units["salinity"] = "Effective salinity units";
  units["npp"] = "g C/m2/year";
  units["sea_ice"] = "proportion";
  units["currents"] = "metres per second";
  units["tides"] = "metres";
  units["sea_state"] = "metres";
  units["sst_trend"] = "degrees Celsius per decade";
  units["coral_bleaching"] = "proportion";
  units["acidification"] = "pH units";
  units["sea_level_rise"] = "metres per decade";
  units["invasive_species"] = "count";

  var hasPalette = new Dictionary<string,bool>();
  hasPalette["sea_depth"] = false;
  hasPalette["ecoregions"] = true;
  hasPalette["economic_zones"] = true;
  hasPalette["vulnerability"] = false;
  hasPalette["migratory_count"] = false;
  hasPalette["protected_areas"] = true;
  hasPalette["coastal_ecosystems"] = true;
  hasPalette["critical_habitat"] = true;
  hasPalette["shipping_density"] = false;
  hasPalette["fish_catches"] = false;
  hasPalette["aquaculture_potential"] = false;
  hasPalette["windpower_potential"] = false;
  hasPalette["wavepower_potential"] = false;
  hasPalette["benthic_roughness"] = false;
  hasPalette["sst"] = false;
  hasPalette["sst_fronts"] = false;
  hasPalette["salinity"] = false;
  hasPalette["npp"] = false;
  hasPalette["sea_ice"] = false;
  hasPalette["currents"] = false;
  hasPalette["tides"] = false;
  hasPalette["sea_state"] = false;
  hasPalette["sst_trend"] = false;
  hasPalette["coral_bleaching"] = false;
  hasPalette["acidification"] = false;
  hasPalette["sea_level_rise"] = false;
  hasPalette["invasive_species"] = false;

  var isCategorical = new Dictionary<string,string>();
  isCategorical["sea_depth"] = "false";
  isCategorical["ecoregions"] = "true";
  isCategorical["economic_zones"] = "true";
  isCategorical["vulnerability"] = "false";
  isCategorical["migratory_count"] = "false";
  isCategorical["protected_areas"] = "true";
  isCategorical["coastal_ecosystems"] = "true";
  isCategorical["critical_habitat"] = "true";
  isCategorical["shipping_density"] = "false";
  isCategorical["fish_catches"] = "false";
  isCategorical["aquaculture_potential"] = "false";
  isCategorical["windpower_potential"] = "false";
  isCategorical["wavepower_potential"] = "false";
  isCategorical["benthic_roughness"] = "false";
  isCategorical["sst"] = "false";
  isCategorical["sst_fronts"] = "false";
  isCategorical["salinity"] = "false";
  isCategorical["npp"] = "false";
  isCategorical["sea_ice"] = "false";
  isCategorical["currents"] = "false";
  isCategorical["tides"] = "false";
  isCategorical["sea_state"] = "false";
  isCategorical["sst_trend"] = "false";
  isCategorical["coral_bleaching"] = "false";
  isCategorical["acidification"] = "false";
  isCategorical["sea_level_rise"] = "false";
  isCategorical["invasive_species"] = "false";

  var maskValues = new Dictionary<string,string>();
  maskValues["sea_depth"] = "false";
  maskValues["ecoregions"] = "false";
  maskValues["economic_zones"] = "false";
  maskValues["vulnerability"] = "false";
  maskValues["migratory_count"] = "false";
  maskValues["protected_areas"] = "false";
  maskValues["coastal_ecosystems"] = "false";
  maskValues["critical_habitat"] = "false";
  maskValues["shipping_density"] = "false";
  maskValues["fish_catches"] = "false";
  maskValues["aquaculture_potential"] = "false";
  maskValues["windpower_potential"] = "false";
  maskValues["wavepower_potential"] = "false";
  maskValues["benthic_roughness"] = "true";
  maskValues["sst"] = "false";
  maskValues["sst_fronts"] = "false";
  maskValues["salinity"] = "false";
  maskValues["npp"] = "false";
  maskValues["sea_ice"] = "false";
  maskValues["currents"] = "false";
  maskValues["tides"] = "false";
  maskValues["sea_state"] = "false";
  maskValues["sst_trend"] = "false";
  maskValues["coral_bleaching"] = "false";
  maskValues["acidification"] = "false";
  maskValues["sea_level_rise"] = "false";
  maskValues["invasive_species"] = "false";

  var speciesCategories = new Dictionary<string, string>();
  speciesCategories["coral"] = "Corals";
  speciesCategories["fish"] = "Marine fish";
  speciesCategories["marine mammal"] = "Marine mammals";
  speciesCategories["seabird"] = "Seabirds";
  speciesCategories["turtle"] = "Marine turtles";

  var occurrenceColours = new Dictionary<string, string>();
  occurrenceColours["coral"] = "purple";
  occurrenceColours["fish"] = "cyan";
  occurrenceColours["marine mammal"] = "orange";
  occurrenceColours["seabird"] = "blue";
  occurrenceColours["turtle"] = "green";

  double oceanMetresSquared = 0;
  double landMetresSquared = 0;
  var landArea = Model.TableListResults.FirstOrDefault(m => m.Name == "land_area"); 
  if (landArea != null) {
    var landRow = landArea.Data.Rows.FirstOrDefault(x => x["Category"] == "Land");
    var noneRow = landArea.Data.Rows.FirstOrDefault(x => x["Category"] == "none");
    if (landRow != null) landMetresSquared = double.Parse(landRow["MetreSquared"]);
    if (noneRow != null) oceanMetresSquared = double.Parse(noneRow["MetreSquared"]);
  }
}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>@siteConfig.Value.InstanceShortName Report</title>
    <meta name="description" content="Ecoset Report">
    <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/styles/report.css">
    <script src="/lib/jquery/jquery.js"></script>
    <script src="/lib/underscore/underscore.js"></script>
    <script src="/lib/d3/d3.js"></script>
    <script src="/lib/topojson-client/dist/topojson.js"></script>
    <script src="/lib/d3-geo-scale-bar/build/d3-geo-scale-bar.js"></script>
    <script src="/scripts/report.js"></script>
  </head>
  
  <body>
    <style> h2 { border-bottom: 2px solid #007cb9 !important; }</style>
    <div class="container">

      @* Section 1. Title Page *@
      <div class="report-title-page">
        <div class="row">
          <div class="six columns">
            <img src="/images/logo-black.png" style="width:25em;margin:10em auto 5em auto" />
            <h1>@siteConfig.Value.InstanceName</h1>
            <h1>@Model.Title</h1>
            @if (!string.IsNullOrEmpty(@Model.Description)) {
              <h2>@Model.Description</h2>
            }
            <p>
              This report provides a series of maps and tables describing the pattern of ecological features in the seascape.
            </p>
            <p>@DateTime.Now.ToLongDateString()</p>
          </div>
        </div>
      </div>

      @* Section 2. Introduction *@
      <div id="report-sections">
        <div id="intro-section" class="report-section">
          <div class="row">
            <div class="col-sm-12">
              <h2>Introduction</h2>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-7">
              <div id="test-map" class="section-map"></div>
              <p>Marine LEFT has been developed to provide a simple interface to spatial datasets to improve situational awareness among industries operating in the global marine environment, and to aid in minimising the environmental impact of operations.</p>
              <p>The tool processes a series of high-quality open access environmental datasets using standardised algorithms to produce maps at 1km resolution.</p>
              <p>This report briefly describes the methods and datasets used to generate the maps for the specified area of interest.</p>
              <p>Please email support@left.ox.ac.uk if you have any questions about this report.</p>
              <h3>Location</h3>
              <p><strong>Specified Area of Interest</strong><br/> Latitude:@Model.South to @Model.North Decimal Degrees. <br/>Longitude: @Model.West to @Model.East Decimal Degrees.</p>
              <svg id="pinpoint-map"></svg>
              <script>
                $(function() {
                  drawGlobalPinpointMap("pinpoint-map", @Model.North, @Model.South, @Model.East, @Model.West)
                });
              </script>
            </div>
            <div class="col-sm-5">
              <img src="https://api.mapbox.com/styles/v1/mapbox/outdoors-v9/static/geojson(%7B%0A%22type%22%3A%22Feature%22%2C%0A%22properties%22%3A%7B%22stroke%22:%22%23FF0000%22%2C%22fill-opacity%22:0.2%7D%2C%0A%22geometry%22%3A%7B%0A%22type%22%3A%22Polygon%22%2C%0A%22coordinates%22%3A%5B%5B%5B @Model.West%2C @Model.South%5D%2C%5B @Model.West%2C @Model.North%5D%2C%5B @Model.East%2C @Model.North%5D%2C%5B @Model.East%2C @Model.South%5D%2C%5B @Model.West%2C @Model.South%5D%5D%5D%0A%7D%0A%7D))/auto/450x450@2x?access_token=@siteConfig.Value.MapboxAccessToken&logo=false" style="width: 100%;"/>
              <p><br/><strong>Open Street Map</strong> in specified area of interest (red rectangle) in @DateTime.Now.Year.<br/>Ramm &amp; Topf (2011) http://planet.openstreetmap.org</p>
            </div>
          </div>
        </div>

        @* Section 3. Context *@
        <div class="report-section" id="economic_zones-section">
          <div class="row">
            <div class="col-md-12">
              <h2>CONTEXT</h2>
            </div>
          </div>
          @{ MapPage("economic_zones"); }
        </div>
        <div class="report-section" id="protected_areas-section">@{ MapPage("protected_areas"); }</div>
        <div class="report-section" id="ecoregions-section">@{ MapPage("ecoregions"); }</div>
        <div class="report-section" id="depth-section">@{ MapPage("sea_depth"); }</div>
        <div class="report-section" id="benthic_roughness-section">@{ MapPage("benthic_roughness"); }</div>
        <div class="report-section" id="coastal_ecosystems-section">@{ MapPage("coastal_ecosystems"); }</div>

        @* Section 4. Biodiversity *@
        <div class="report-section" id="species-occurrence-section">
          <div class="row">
            <div class="col-md-12">
              <h2>BIODIVERSITY</h2>
              <h3>Biodiversity Records</h3>
              <hr/>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-5">
              <p>Georeferenced species occurrence records were retrieved from the Global Biodiversity Information Facility (GBIF; www.gbif.org).  The map shows the distribution of biodiversity records in the area of interest plus a 3-degree buffer.  Any duplicate records (of the same species more than once at the same location) have been removed. The sources of the records are acknowledged in Appendix 4.</p>
              @{ var gbiflist = Model.TableListResults.FirstOrDefault(m => m.Name == "biodiversity_records_count"); }
              <table class="table">
                <thead>
                  <tr>
                    <th></th>
                    <th>Class</th>
                    <th>Species</th>
                    <th>Occurrences</th>
                  </tr>
                </thead>
                <tbody>
                  @if(gbiflist != null) {
                    @foreach (KeyValuePair<string, string> entry in occurrenceColours) {
                      var gbifCount = gbiflist.Data.Rows.FirstOrDefault(m => m["taxon"] == entry.Key);
                      var colour = occurrenceColours[entry.Key];
                      var prettyTaxon = speciesCategories[entry.Key.ToLower()];
                      @if(gbifCount != null) {
                        <tr>
                          <td><svg height="20" width="20"><circle r="4" cx="10" cy="10" stroke="@colour" fill="none"></circle></svg></td>
                          <td>@prettyTaxon</td>
                          <td>@gbifCount["species"]</td>
                          <td>@gbifCount["count"]</td>
                        </tr>
                      } else {
                        <tr>
                          <td><svg height="20" width="20"><circle r="4" cx="10" cy="10" stroke="@colour" fill="none"></circle></svg></td>
                          <td>@prettyTaxon</td>
                          <td>0</td>
                          <td>0</td>
                        </tr>
                      }
                    }
                  }
                </tbody>
              </table>
            </div> @* End col-sm-5 *@
            <div class="col-sm-7">
              <div id="biodiversity_records-map" class="section-map"></div>
              <p class="map-caption"><br/><strong>Biodiversity Records</strong> from the Global Biodiversity Information Facility (GBIF) in specified area of interest (red rectangle) and in a surrounding 3 degree buffer in 2019.  Land is shown in grey. </p>
            </div>
          </div> @* End row *@
          <div class="create-script">
            @{
                var occurrence = Model.TableListResults.FirstOrDefault(m => m.Name == "biodiversity_records");
                if (occurrence != null) {
                  <script>
                    $(function() {
                      var north = @Model.North;
                      var south = @Model.South;
                      var east = @Model.East;
                      var west = @Model.West;

                      north = Math.min(90, north + 3);
                      south = Math.max(-90, south - 3);
                      east = Math.min(180, east + 3);
                      west = Math.max(-180, west - 3);

                      var plot = new SpatialPlot("biodiversity_records", {north:north,south:south,east:east,west:west});
                      plot.setup();
                      plot.addGraticule();
                      plot.addWireframe();
                      plot.addPointLayer(@Html.Raw(JsonSerializer.Serialize(occurrence.Data.Rows)), @Html.Raw(JsonSerializer.Serialize(occurrenceColours)));
                      plot.addBox(@Model.North,@Model.South,@Model.East,@Model.West);

                      populateDataSources(@Html.Raw(JsonSerializer.Serialize(occurrence.Data.Rows)));
                    });
                  </script>
                }
              }
          </div>
        </div>
        <div class="report-section" id="depth-section">
          <div class="row">
            <div class="col-md-12">
              <h3>Biodiversity Data Quality</h3>
              <hr/>
              <p>The output and validity of results will be significantly influenced by the availability or, conversely, the paucity, of data available in the databases for the selected region. The most critical data in this respect are the species occurrence records contained in GBIF. Due to sampling bias, GBIF coverage for some regions of the world is better than others (Gaiji et al., 2012). In order to provide a first estimate of the confidence that can be placed in the output from a region, a metric to assess the density of species occurrence records was devised. In this, the number of species records was obtained from GBIF for each taxonomic group (amphibians, reptiles, birds, mammals, plants) in the user-specified area of interest, as well as in a much larger reference area comprising the WWF ecoregions that intersect the area of interest. Species density was then calculated by dividing the number of different species in an area by the size of the area raised to an exponent of 0.2. Exponentiation is necessary in order to consistently control for the logarithmic form of species-area relationships and allow species densities from areas of different sizes to be directly comparable (Rosenweig 2012). The density of local species occurrence records for a taxonomic group can be compared to the density of records for the same group in the much larger reference area. This gives a first approximation of the degree to which the GBIF records available for a specified area of interest provide a good representation of the species expected in that area, based on wider biogeographical patterns and species-area relationships.</p>
              <p>The table below shows species densities for the area of interest and the broader reference area, and the ratio of those densities. A representation score above 1.0 means that the number of species records retrieved was higher than expected, so the data are more reliable. Representation below 1.0 indicates poorer GBIF coverage and less reliable species data.</p>
              <table class="table">
                <thead>
                  <tr>
                    <th>Taxon</th>
                    <th>Species density (area of interest)</th>
                    <th>Species density (reference area)</th>
                    <th>Representation</th>
                  </tr>
                </thead>
                <tbody>
                  @foreach (KeyValuePair<string, string> entry in speciesCategories) {
                    var densityResultsZonal = Model.TableStatsResults.FirstOrDefault(m => m.Name == "species_density_" + entry.Key.Replace(" ", ""));
                    var localString = "Unknown";
                    var zonalString = "Unknown";
                    double localValue = 1.0;
                    double zonalValue = 1.0;
                    var representationString = "None";
                    
                    var gbifCount = gbiflist.Data.Rows.FirstOrDefault(m => m["taxon"] == entry.Key);
                    if (gbifCount != null && oceanMetresSquared != 0) {
                      localValue = double.Parse(gbifCount["species"]) / System.Math.Pow((oceanMetresSquared * 0.000001), 0.2);
                      localString = Math.Round(localValue, 2).ToString();
                    }
                    if(densityResultsZonal != null) {
                      zonalValue = densityResultsZonal.Data.Stats.Mean;
                      zonalString = Math.Round(zonalValue, 2).ToString();
                    }
                    if(localString != "Unknown" && zonalString != "Unknown") {
                      representationString = Math.Round(localValue / zonalValue, 2).ToString();
                    }

                    <tr>
                      <td>@entry.Value</td>
                      <td>@localString</td>
                      <td>@zonalString</td>
                      <td>@representationString</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="report-section" id="vulnerability-section">@{ MapPage("vulnerability"); }</div>
        <div class="report-section" id="migratory_count-section">@{ MapPage("migratory_count"); }</div>
        <div class="report-section" id="critical_habitat-section">@{ MapPage("critical_habitat"); }</div>


        @* Section 5. Competing Uses *@
        <div class="report-section" id="competing-uses-section">
          <div class="row">
            <div class="col-md-12">
              <h2>COMPETING USES</h2>
            </div>
          </div>
          @{ MapPage("shipping_density"); }
        </div>
        <div class="report-section" id="fish_catches-section">@{ MapPage("fish_catches"); }</div>
        <div class="report-section" id="aquaculture_potential-section">@{ MapPage("aquaculture_potential"); }</div>
        <div class="report-section" id="windpower_potential-section">@{ MapPage("windpower_potential"); }</div>
        <div class="report-section" id="wavepower_potential-section">@{ MapPage("wavepower_potential"); }</div>


        @* Section 6. Processes *@
        <div class="report-section" id="competing-uses-section">
          <div class="row">
            <div class="col-md-12">
              <h2>PROCESSES</h2>
            </div>
          </div>
          @{ MapPage("sst"); }
        </div>
        <div class="report-section" id="sst_fronts-section">@{ MapPage("sst_fronts"); }</div>
        <div class="report-section" id="salinity-section">@{ MapPage("salinity"); }</div>
        <div class="report-section" id="npp-section">@{ MapPage("npp"); }</div>
        <div class="report-section" id="sea_ice-section">@{ MapPage("sea_ice"); }</div>
        <div class="report-section" id="currents-section">@{ MapPage("currents"); }</div>
        <div class="report-section" id="tides-section">@{ MapPage("tides"); }</div>
        <div class="report-section" id="sea_state-section">@{ MapPage("sea_state"); }</div>

        @* Section 7. Threats *@
        <div class="report-section" id="competing-uses-section">
          <div class="row">
            <div class="col-md-12">
              <h2>THREATS</h2>
            </div>
          </div>
          @{ MapPage("sst_trend"); }
        </div>
        <div class="report-section" id="coral_bleaching-section">@{ MapPage("coral_bleaching"); }</div>
        <div class="report-section" id="acidification-section">@{ MapPage("acidification"); }</div>
        <div class="report-section" id="sea_level_rise-section">@{ MapPage("sea_level_rise"); }</div>
        <div class="report-section" id="invasive_species-section">@{ MapPage("invasive_species"); }</div>

        @* Section 8. Zonal Statistics *@
        <div class="report-section">
          <div class="row">
            <div class="col-md-12">
              <h2>DATA ASSURANCE: <small>Comparison to Other Regions (COAM)</small></h2>
              <p>To appreciate the importance of the ecological values obtained for the specified area of interest relative to other regions, a 'compared to other areas metric' (COAM) was calculated. This metric used the polygons of the WWF Terrestrial Ecoregion Classification (Olson et al, 2001) to identify zones ecologically similar to the area of interest. Zonal statistics were then used to assess the importance of each LEFT layer relative to the same measure over the entire ecoregion. For each layer, the difference in standard scores between the area of interest and the broader ecoregions is presented in the following chart. This shows whether a study area is relatively more or less ecologically valuable than other regions with similar biogeographic characterisitics.</p>
              @{
                var coamContext = new List<string>() { "sea_depth", "benthic_roughness", "protected_areas" };
                var coamBiodiversity = new List<string>() { "vulnerability", "migratory_count" };
                var coamCompetingUses = new List<string>() { "shipping_density", "fish_catches", "windpower_potential", "wavepower_potential", "aquaculture_potential" };
                var coamProcesses = new List<string>() { "sst", "sst_fronts", "salinity", "npp", "sea_ice", "currents", "tides", "sea_state" };
                var coamThreats = new List<string>() { "sst_trend", "coral_bleaching", "acidification", "sea_level_rise", "invasive_species" };
              }
            </div>
          </div>
          <div class="row">
            <div class="col-sm-6">
              <p class="coam-heading">Context</p>
              @{ CoamGraph(coamContext); }
              <p class="coam-heading">Biodiversity</p>
              @{ CoamGraph(coamBiodiversity); }
              <p class="coam-heading">Competing Uses</p>
              @{ CoamGraph(coamCompetingUses); }
            </div>
            <div class="col-sm-6">
              <p class="coam-heading">Processes</p>
              @{ CoamGraph(coamProcesses); }
              <p class="coam-heading">Threats</p>
              @{ CoamGraph(coamThreats); }
            </div>
          </div>
          <div class="row">
            <div class="col-sm-12">
              <p class="coam-legend">Charts indicating the importance of the area of interest relative to the reference region for each layer (standard scores +/- uncertainty in standard scores). If a layer has a positive standard score then the area of interest is more important than the reference region; a layer with a negative standard score is less important in the study area than in the reference region.</p>
            </div>
          </div>
        </div>

        <div class="report-section">
          <div class="row">
            <div class="col-sm-12">
              <h3>Dataset Statistics (COAM)</h3>
              <hr/>
              <p class="coam-heading">Context</p>
              @{ CoamTable(coamContext); }
              <p class="coam-heading">Biodiversity</p>
              @{ CoamTable(coamBiodiversity); }
              <p class="coam-heading">Competing Uses</p>
              @{ CoamTable(coamCompetingUses); }
              <p class="coam-heading">Processes</p>
              @{ CoamTable(coamProcesses); }
              <p class="coam-heading">Threats</p>
              @{ CoamTable(coamThreats); }
            </div>
          </div>
        </div>

        @* Section 9. References *@
        <div class="report-section">
          <div class="row">
            <div class="col-sm-12">
              
              <h2>References</h2>
              <ul class="reference-list">
                <li>
                  Behrenfeld MJ, Falkowski PG (1997) Photosynthetic rates derived from satellite-based chlorophyll concentration.  Limmnology and Oceanography 42: 1-20
                </li>
                <li>
                  Brasnett B (2008) The impact of satellite retrievals in a global sea-surface-temperature analysis. Quarterly Journal of the Royal Meteorological Society 134: 1745-1760.                </li>
                <li>
                  Bunting P, Rosenquist A, Lucas R, Rebelo LM, Hilarides L, Thomas N, Hardy A, Itoh T, Shimada M, Finlayson CM (2018) The global mangrove watch – a new 2010 global baseline of mangrove extent.  Remote Sensing 10: 1669
                  <a href="http://www.eorc.jaxa.jp/ALOS/en/kyoto/mangrovewatch.htm">http://www.eorc.jaxa.jp/ALOS/en/kyoto/mangrovewatch.htm</a>
                </li>
                <li>
                  Byrnes et al (2016) Global Kelp Timeseries from NCEAS\KEEN working group.
                  <a href="http://www.kelpecosystems.org">http://www.kelpecosystems.org</a>
                </li>
                <li>
                  Canada Meteorological Center. (2016) GHRSST Level 4 CMC0.1deg Global Foundation Sea Surface Temperature Analysis (GDS version 2). Ver. 3.0. PO.DAAC, CA, USA.
                  <a href="https://doi.org/10.5067/GHCMC-4FM03">https://doi.org/10.5067/GHCMC-4FM03</a>
                </li>
                <li>
                  Flanders Marine Institute (2018). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 10. 
                  <a href="http://www.marineregions.org/ https://doi.org/10.14284/312">http://www.marineregions.org/ https://doi.org/10.14284/312</a>.
                </li>
                <li>Halpern BS, Frazier M, Potapenko J, Casey KS, Koenig J, Longo C, Lowndes JS, Cotton Rockwood R, Selig ER, Selkoe KA, Walbridge S (2015) Spatial and temporal changes in cumulative human impacts on the world's oceans.  Nature Communicaitons 6: 7615</li>
                <li>IFC (International Finance Corporation). (2012a). Performance Standard 6: Biodiversity Conservation and Sustainable Management of Living Natural Resources. World Bank Group, Washington, DC. 7pp.</li>
                <li>
                  IFC (International Finance Corporation). (2012b). Guidance Note 6: Biodiversity Conservation and Sustainable Management of Living Natural Resources. World Bank Group, Washington, DC. 69pp.
                  <a href="https://www.ifc.org/wps/wcm/connect/topics_ext_content/ifc_external_corporate_site/sustainability-at-ifc/policies-standards/performance-standards/ps6">https://www.ifc.org/wps/wcm/connect/topics_ext_content/ifc_external_corporate_site/sustainability-at-ifc/policies-standards/performance-standards/ps6</a>.
                </li>
                <li>
                  IUCN (2020) Red list of threatened species.  Version 2020-1
                  <a href="https://www.iucnredlist.org/">https://www.iucnredlist.org/</a>.
                </li>
                <li>
                  Legeais JF, Ablain M, Zawadzki L, Zuo H, Johannessen JA, Scharffenberg MG, Fenoglio ML, Fernandes MJ, Andersen OB, Rudenko S, Cipollini P, Quartly GD, Passaro M, Cazenave A, Benveniste J (2018) An improved and homogeneous altimeter sea level record from the ESA Climate Change Initiative, Earth Systems Science Data 10: 281-301
                  <a href="https://doi.org/10.5194/essd-10-281-2018">https://doi.org/10.5194/essd-10-281-2018</a>
                </li>
                <li>
                  Merchant CJ, Embury O, Roberts-Jones J, Fiedler E, Bulgin CE, Corlett GK, Good S, McLaren A, Rayner N, Morak-Bozzo S, Donlon C (2014), Sea surface temperature datasets for climate applications from Phase 1 of the European Space Agency Climate Change Initiative (SST CCI). Geoscience Data Journal, 1:179–191. 
                  <a href="https://doi.org/10.1002/gdj3.20">https://doi.org/10.1002/gdj3.20</a>
                </li>
                <li>
                  McOwen C, Weatherdon LV, Bochove J, Sullivan E, Blyth S, Zockler C, Stanwell-Smith D, Kingston N, Martin CS, Spalding M, Fletcher S (2017). A global map of saltmarshes. Biodiversity Data Journal 5: e11764.
                  <a href="http://data.unepwcmc.org/datasets/43">http://data.unepwcmc.org/datasets/43</a>.
                </li>
                <li>
                  Murray N. J., Phinn S. R., DeWitt M., Ferrari R., Johnston R., Lyons M. B., Clinton N.,Thau D. & Fuller R. A. (2019) The global distribution and trajectory of tidal flats. Nature. 565:222-225. http://dx.doi.org/10.1038/s41586-018-0805-8
                  <a href="http://data.unepwcmc.org/datasets/47">http://data.unepwcmc.org/datasets/47</a>.
                </li>
                <li>
                  Pagad S, Genovesi P, Carnevali L, Scalera R, Clout M (2015) IUCN SSC Invasive Species Specialist Group: invasive alien species information management supporting practititioners, policy makers and decision takers.  Management of Biological Invasions 6: 127-135
                  <a href="http://iucngisd.org/gisd/">http://iucngisd.org/gisd/</a>
                </li>
                <li>
                  Passaro M (2019) ESA CCI sea state algorithm theoretical basis document (ATBD)
                  <a href="http://http://cci.esa.int/sites/default/files/Sea_State_cci_ATBD_v1.1-signed_0.pdf">http://http://cci.esa.int/sites/default/files/Sea_State_cci_ATBD_v1.1-signed_0.pdf</a>
                </li>
                <li>
                  Ramm F, Topf J, Chilton S (2011) Open Street Map: using and enhancing the free map of the world.  UIT Cambridge.
                  <a href="http://planet.openstreetmap.org">http://planet.openstreetmap.org</a>.
                </li>
                <li>
                  Riede, K (2004). Global register of migratory species: from global to regional scales: final report of the R&D-Projekt 808 05 081, Federal Agency for Nature Conservation.
                  <a href="http://www.groms.de/ ">http://www.groms.de/ </a>.
                </li>
                <li>
                  Sharp R, Tallis HT, Ricketts T, Guerry AD, Wood SA, Chaplin-Kramer R, Nelson E, Ennaanay D, Wolny S, Olwero N, Vigerstol K, Pennington D, Mendoza G, Aukema J, Foster J, Forrest J, Cameron D,  Arkema K,  Lonsdorf  E,  Kennedy C,  Verutes G,  Kim CK,  Guannel G,  Papenfus  M,  Toft J,  Marsik M, Bernhardt J, Griffin R, Glowinski K, Chaumont N, Perelman A, Lacayo M, Mandle L, Hamel P, Vogl AL, Rogers L, Bierbower W, Denu D, Douglass J (2018)  InVEST 3.6.0 Users' Guide.   The Natural Capital Project
                  <a href="http://data.naturalcapitalproject.org/nightly-build/invest-users-guide/html/  ">http://data.naturalcapitalproject.org/nightly-build/invest-users-guide/html/  </a>.
                </li>
                <li>
                  Skirving W, Enríquez S, Hedley J, Dove S, Eakin CM, Mason RAB, De La Cour JL, Liu G, Hoegh-Guldberg O, Strong AE, Mumby PJ, Iglesias-Prieto R (2018) Remote Sensing of Coral Bleaching Using Temperature and Light: Progress towards an Operational Algorithm (2018) Remote Sensing  10: 18 
                  <a href="http://doi.org/10.3390/rs10010018">http://doi.org/10.3390/rs10010018</a>
                </li>
                <li>
                  Spalding MD, Fox HE, Allen GR, Davidson N, Ferdana ZA, Finlayson M, Halpern BS, Jorge MA, Lombana A, Martin KD, McManus E, Molnar J, Recchia CA, Robertson J (2007) Marine Ecoregions of the World.  Bioscience 57: 573-583
                  <a href="https://www.worldwildlife.org/publications/marine-ecoregions-of-the-world-a-bioregionalization-of-coastal-and-shelf-areas">https://www.worldwildlife.org/publications/marine-ecoregions-of-the-world-a-bioregionalization-of-coastal-and-shelf-areas</a>.
                </li>
                <li>
                  UNEP-WCMC, Short FT (2018). Global Distribution of Seagrasses (version 6). Sixth update to the data layer used in Green and Short (2003), superseding version 5. Cambridge (UK): UN Environment World Conservation Monitoring Centre.
                  <a href="http://data.unep-wcmc.org/datasets/7">http://data.unep-wcmc.org/datasets/7</a>.
                </li>
                <li>
                 UNEP-WCMC, Worldfish Centre, WRI, TNC (2018) Global distribution of warm water coral reefs, complied from multiple sources including the Millennium Coral Reef Mapping project. Version 4.  Cambridge (UK): UN Environment World Conservation Monitoring Centre.
                 <a href="http://data.unep-wcmc.org/datasets/1">http://data.unep-wcmc.org/datasets/1</a>.
                </li>
                <li>
                  Vergely et al (2019) Climate Change Initiative + (CCI+) phase 1 sea surface salinity algorithm theoretical basis document.
                  <a href="http://cci.esa.int/sites/default/files/filedepot/SSS_cci-D2.3-ATBD-v1.3-signed.pdf">http://cci.esa.int/sites/default/files/filedepot/SSS_cci-D2.3-ATBD-v1.3-signed.pdf</a>
                </li>
                <li>
                  Weatherall P., Marks KM, Jakobsson M, Schmitt T, Tani S, Arndt JE, Rovere M, Chayes D, Ferrini V, Wigley R(2015), A new digital bathymetric model of the world’s oceans, Earth and Space Science, 2: 331–345, doi: 10.1002/2015EA000107
                  <a href="https://gebco.net">https://gebco.net</a>.
                </li>
                <li>
                  Wilson MFJ, O’Connell B, Brown C, Guinan JC, Grehan AJ (2007) Multiscale terrain analysis of multibeam bathymetry data for habitat mapping on the continental slope.  Marine Geodesy 30: 3-35
                </li>
                <li>
                  Zhang, HM, Bates JJ, Reynolds RW (2006_ Assessment of composite global sampling: Sea surface wind speed, Geophysical Research Letters, 33, L17714
                  <a href="https://www.ncdc.noaa.gov/data-access/marineocean-data/blended-global/blended-sea-winds">https://www.ncdc.noaa.gov/data-access/marineocean-data/blended-global/blended-sea-winds</a>.
                </li>
              </ul>
            </div>
          </div>
        </div>

        @* Section 10. Marine Protected Area list *@
        <div class="report-section">
          <div class="row">
            <div class="col-sm-12">
              <div id="marine-protected-areas" class="appendix">
                <h2>Appendix 1 - Marine Protected Areas</h2>
                <p>The World Database of Protected Areas (WDPA 2019) include the following marine protected area in the specified area of interest.</p>
                <ul id="marine-protected-areas-list" class="list-group row appendix-list">
                @{
                  var mpa = Model.TableListResults.FirstOrDefault(m => m.Name == "protected_area_list");
                  if (mpa != null) {
                    @foreach (var r in mpa.Data.Rows) {
                      <li class="list-group-item col-xs-3"><em>@r["string"]</em></li>
                    }
                  }
                }
                </ul>
              </div>
            </div>
          </div>
        </div>


        @* Section 11. Vulnerable species list *@
        <div class="report-section">
          <div class="row">
            <div class="col-sm-12">
              <div id="vulnerable-species" class="appendix">
                <h2>Appendix 2 - Vulnerable species</h2>
                <p>The IUCN Redlist of Threatened Species (IUCN 2018) includes the following species of corals, fish, turtles, sea birds and marine mammals that have been modelled to be potentially present in the specified area of interest (NT = Near Threatened, VU = Vulnerable, EN = Endangered, CR = Critically Endangered)</p>
                <ul id="vulnerable_species_names" class="list-group row appendix-list">
                  @{
                    var vulnerable = Model.TableListResults.FirstOrDefault(m => m.Name == "vulnerable_species_names");
                    if (vulnerable != null) {
                      @foreach (var r in vulnerable.Data.Rows) {
                        var latinName = r["string"].Split('(')[0];
                        var bracket = "(" + r["string"].Split('(')[1];
                        <li class="list-group-item col-xs-4"><em>@latinName</em> @bracket</li>
                      }
                    }
                  }
                </ul>
              </div>
            </div>
          </div>
        </div>

        @* Section 12. Migratory species list *@
        <div class="report-section">
          <div class="row">
            <div class="col-sm-12">
              <div id="migratory-species" class="appendix">
                <h2>Appendix 3 - Migratory Species</h2>
                <p>The following migratory species identified in the Global register of Migratory Species (GROMS; Riede et al 2004) have migration routes which intersect the specified area of interest.</p>
                <ul id="migratory-species-list" class="list-group row appendix-list">
                @{
                  var migratory = Model.TableListResults.FirstOrDefault(m => m.Name == "migratory_names");
                  if (migratory != null) {
                    @foreach (var r in migratory.Data.Rows) {
                      <li class="list-group-item col-xs-3"><em>@r["string"]</em></li>
                    }
                  }
                }
                </ul>
              </div>
            </div>
          </div>
        </div>

        @* Section 13. Data sources *@
        <div class="report-section">
          <div class="row">
            <div class="col-sm-12">
              <div id="data-sources" class="appendix">
                <h2>Appendix 4 - Data Sources</h2>
                <p>Georeferenced species records obtained from the GBIF occurrence API (http://www.gbif.org/occurrence) are shared according to the GBIF Data Use Agreement, which includes the provision that users of any data accessed through or retrieved via the GBIF Portal will always give credit to the original data publishers. The following list identifies the data sources for all occurrence records which have been used in this analysis.</p>
                <ul id="data-source-list" class="list-group row appendix-list"></ul>
              </div>
            </div>
          </div>
        </div>

      </div>
    </body>
  </html>


@{
    void CoamGraph(List<string> variables) {
      var graphId = "coam-" + Guid.NewGuid().ToString();
      var variablesToDraw = Model.RawResults.Where(r => variables.Contains(r.Name));
      var height = 10 + 20 + 30 * variablesToDraw.Count();
      <svg id="@graphId" width="500" height="@height"></svg>
      <script>
        $(function() { 
          var data = [];
          @foreach (var result in variablesToDraw) {
              var tableStatsResultsMean = Model.TableStatsResults.FirstOrDefault(m => m.Name == result.Name + "_zonalmean");
              var tableStatsResultsStdev = Model.TableStatsResults.FirstOrDefault(m => m.Name == result.Name + "_zonalstdev");
              if(tableStatsResultsMean != null && tableStatsResultsStdev != null) {
                var localMean = result.Data.Stats.Mean;
                var localStdev = result.Data.Stats.StdDev;
                var zonalMeanScaled = tableStatsResultsMean.Data.Stats.Mean / 1;
                var zonalStdevScaled = tableStatsResultsStdev.Data.Stats.Mean / 1;
                var z = (localMean - zonalMeanScaled) / zonalStdevScaled;
                var sd = localStdev / zonalStdevScaled;
                <text>
                data.push({
                  "name": "@prettyTitles[result.Name]",
                  "value": @z,
                  "sd": @sd
                });
                </text>
              }
          }
          drawCoamGraph('@graphId', data, { top: 10, right: 70, bottom: 20, left: 160 });
        });
      </script>
    }

    void CoamTable(List<string> variables) {
      var variablesToDraw = Model.RawResults.Where(r => variables.Contains(r.Name));
      <table class="table">
        <thead>
          <tr>
            <th></th>
            <th>Min</th>
            <th>Max</th>
            <th>Mean</th>
            <th>SD</th>
            <th>Ref. Mean</th>
            <th>Ref. SD</th>
          </tr>
        </thead>
        @foreach (var result in variablesToDraw) {
          <tr>
            <td>@prettyTitles[result.Name]</td>
            <td>@result.Data.Stats.Min</td>
            <td>@result.Data.Stats.Max</td>
            <td>@result.Data.Stats.Mean</td>
            <td>@result.Data.Stats.StdDev</td>
            @{
              var foundmean = false;
              var foundstdev = false;
              var refmean = "";
              var refstdev = "";
              var prefix = result.Name;
              var tableStatsResultsMean = Model.TableStatsResults.FirstOrDefault(m => m.Name == prefix + "_zonalmean");
              var tableStatsResultsStdev = Model.TableStatsResults.FirstOrDefault(m => m.Name == prefix + "_zonalstdev");
            }
            @if (tableStatsResultsMean != null) {
              refmean = (Math.Round(tableStatsResultsMean.Data.Stats.Mean / 1, 3)).ToString();
              foundmean = true;
            }

            @if (tableStatsResultsStdev != null) {
              refstdev = (Math.Round(tableStatsResultsStdev.Data.Stats.Mean / 1, 3)).ToString();
              foundstdev = true;
            }
            @if (foundmean) {
              <td>@refmean</td>
            } else {
              <td>Unknown</td>
            }
            @if (foundstdev) {
              <td>@refstdev</td>
            } else {
              <td>Unknown</td> 
            }
          </tr>
        }
      </table>
    }

    void MapPage(string variableId)
    {
      var paletteUrl = hasPalette[variableId] ? "/palettes/" + variableId + ".json" : null;
      var executableResult = Model.RawResults.FirstOrDefault(m => m.Name == variableId);
      if (executableResult == null) return;
      <div class="row">
          <div class="col-sm-12">
            <h3>@prettyTitles[variableId]</h3>
            <hr/>
          </div>
        </div>
      <div class="row">
        <div class="col-sm-5">

          <p>
            @Html.Raw(descriptions[variableId])
          </p>

          <div class="panel panel-default legend">
            <div class="panel-heading">@units[variableId]</div>
            <div class="panel-body">
              <div id="@variableId-scale" class="section-scale"></div>
            </div>
          </div>
        </div>
        <div class="col-sm-7">
        <div id="@variableId-map" class="section-map"></div>
        <p class="map-caption"><strong>@prettyTitles[variableId]</strong> @mapLegend[variableId]</p>
        </div>
      </div>
      <div class="create-script">
        <script>
          $(function() {
            var north = @Model.North;
            var south = @Model.South;
            var east = @Model.East;
            var west = @Model.West;

            if("@executableResult.Name" == "ecoregions") {
              north = Math.min(90, north + 3);
              south = Math.max(-90, south - 3);
              east = Math.min(180, east + 3);
              west = Math.max(-180, west - 3);
            }

            var plot = new SpatialPlot("@executableResult.Name", {north:north, south:south, east:east, west:west});
            plot.setup();
            plot.addGraticule();
            plot.addRasterLayer(@Html.Raw(JsonSerializer.Serialize(executableResult.Data)), null, "@paletteUrl", @maskValues[executableResult.Name], @isCategorical[executableResult.Name]);
            plot.addBox(@Model.North,@Model.South,@Model.East,@Model.West);
          });
        </script>
      </div>
  }
}